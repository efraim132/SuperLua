<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperLua Transpiler</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #0d1117;
            color: #e6edf3;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid #21262d;
        }

        .header h1 {
            color: #f0f6fc;
            font-size: 32px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }

        .header p {
            color: #7d8590;
            font-size: 16px;
            margin: 0;
        }

        .main-content {
            display: flex;
            gap: 16px;
            height: 600px;
        }

        .input-section, .output-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .section-header {
            background-color: #21262d;
            color: #f0f6fc;
            padding: 12px 16px;
            border: 1px solid #30363d;
            border-radius: 6px 6px 0 0;
            font-weight: 600;
            font-size: 14px;
        }

        textarea {
            flex: 1;
            border: 1px solid #30363d;
            border-top: none;
            padding: 16px;
            font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
            font-size: 14px;
            line-height: 1.45;
            resize: none;
            outline: none;
            border-radius: 0 0 6px 6px;
            background-color: #0d1117;
            color: #e6edf3;
        }

        textarea:focus {
            border-color: #1f6feb;
            box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.3);
        }

        textarea::placeholder {
            color: #7d8590;
        }

        #input-code {
            border-right: 1px solid #30363d;
        }

        .controls {
            text-align: center;
            margin: 24px 0;
        }

        .transpile-btn {
            background-color: #238636;
            color: #ffffff;
            border: 1px solid rgba(240, 246, 252, 0.1);
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .transpile-btn:hover {
            background-color: #2ea043;
        }

        .transpile-btn:active {
            background-color: #1a7f37;
        }

        .transpile-btn:disabled {
            background-color: #21262d;
            color: #7d8590;
            cursor: not-allowed;
        }

        .examples {
            margin-top: 24px;
            padding: 16px;
            background-color: #0d1117;
            border: 1px solid #21262d;
            border-radius: 6px;
        }

        .examples h3 {
            margin: 0 0 12px 0;
            color: #f0f6fc;
            font-size: 16px;
            font-weight: 600;
        }

        .example-btn {
            background-color: #21262d;
            color: #e6edf3;
            border: 1px solid #30363d;
            padding: 8px 12px;
            margin: 4px 8px 4px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 12px;
        }

        .example-btn:hover {
            background-color: #30363d;
        }

        .status {
            text-align: center;
            margin: 16px 0;
            padding: 12px 16px;
            border-radius: 6px;
            display: none;
            font-size: 14px;
        }

        .status.success {
            background-color: #0f2419;
            color: #3fb950;
            border: 1px solid #1a2f1a;
        }

        .status.error {
            background-color: #2d1117;
            color: #f85149;
            border: 1px solid #3e1319;
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 16px;
            }

            .main-content {
                flex-direction: column;
                height: auto;
            }

            textarea {
                height: 300px;
            }

            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SuperLua Transpiler</h1>
            <p>Transform your SuperLua code with classes into standard Lua</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <div class="section-header">
                    SuperLua Input
                </div>
                <textarea
                    id="input-code"
                    placeholder="Enter your SuperLua code here...

Example:
class Vector
    function new(self, x, y)
        self.x = x or 0
        self.y = y or 0
    end

    function add(self, other)
        return Vector:new(self.x + other.x, self.y + other.y)
    end
end"></textarea>
            </div>

            <div class="output-section">
                <div class="section-header">
                    Lua Output
                </div>
                <textarea
                    id="output-code"
                    readonly
                    placeholder="Transpiled Lua code will appear here..."></textarea>
            </div>
        </div>

        <div class="controls">
            <button class="transpile-btn" id="transpile-btn">
                Transpile Code
            </button>
        </div>

        <div class="status" id="status"></div>

        <div class="examples">
            <h3>Quick Examples</h3>
            <button class="example-btn" id="vector-example">Vector Class</button>
            <button class="example-btn" id="person-example">Person Class</button>
            <button class="example-btn" id="calculator-example">Calculator Class</button>
        </div>
    </div>

    <py-script>
import re
from js import document, console

def transpile_superlua(input_code):
    output_code = []

    # Split input into lines for easier processing
    lines = input_code.split('\n')
    i = 0

    while i < len(lines):
        line = lines[i].strip()

        # Check if we're starting a class
        if line.startswith('class '):
            class_name = line.split()[1]
            output_code.append(f"{class_name} = {{}}")
            output_code.append(f"{class_name}.__index = {class_name}")
            output_code.append("")
            i += 1

            # Process class body
            while i < len(lines):
                line = lines[i].strip()

                # Check if we're at the end of the class
                if line == 'end':
                    break

                # Check if we're starting a function
                if line.startswith('function '):
                    # Parse function declaration
                    func_line = line
                    func_match = re.match(r'function\s+(\w+)\s*\((.*?)\)', func_line)
                    if func_match:
                        method_name = func_match.group(1)
                        method_args = func_match.group(2).strip()

                        # Collect function body until matching 'end'
                        i += 1
                        method_body = []
                        end_count = 1  # We need to find the matching 'end'

                        while i < len(lines) and end_count > 0:
                            current_line = lines[i]
                            stripped_line = current_line.strip()

                            # Count nested structures
                            if stripped_line.startswith('if ') or stripped_line.startswith('for ') or stripped_line.startswith('while ') or stripped_line.startswith('function '):
                                end_count += 1
                            elif stripped_line == 'end':
                                end_count -= 1

                            # Add line to body if we haven't found the matching end
                            if end_count > 0:
                                method_body.append(current_line)

                            i += 1

                        # Generate the method
                        if method_name == "new":
                            # Constructor
                            clean_args = method_args.replace('self', '').strip()
                            if clean_args.startswith(','):
                                clean_args = clean_args[1:].strip()
                            output_code.append(f"function {class_name}:{method_name}({clean_args})")
                            output_code.append(f"  local self = setmetatable({{__class = '{class_name}'}}, {class_name})")
                            for body_line in method_body:
                                output_code.append("  " + body_line)
                            output_code.append("  return self")
                            output_code.append("end")
                        else:
                            # Regular method - remove 'self' from parameters since colon syntax provides it
                            clean_args = method_args.replace('self', '').strip()
                            if clean_args.startswith(','):
                                clean_args = clean_args[1:].strip()
                            if clean_args.endswith(','):
                                clean_args = clean_args[:-1].strip()
                            output_code.append(f"function {class_name}:{method_name}({clean_args})")
                            for body_line in method_body:
                                output_code.append("  " + body_line)
                            output_code.append("end")

                        output_code.append("")
                        i -= 1  # Adjust because we'll increment at the end of the loop
                else:
                    # Non-function line within class - skip or preserve comments
                    if line and not line.startswith('--'):
                        pass  # Skip non-comment, non-function lines in class

                i += 1

            output_code.append("")
        else:
            # Non-class line - preserve it
            output_code.append(lines[i])

        i += 1

    return "\n".join(output_code)

def show_status(message, is_error=False):
    status_element = document.getElementById("status")
    status_element.style.display = "block"
    status_element.className = "status error" if is_error else "status success"
    status_element.innerHTML = message

def hide_status():
    status_element = document.getElementById("status")
    status_element.style.display = "none"

def transpile_code(*args):
    try:
        console.log("Transpile button clicked")
        hide_status()
        input_code = document.getElementById("input-code").value

        if not input_code.strip():
            show_status("Please enter some SuperLua code to transpile.", True)
            return

        # Update button text to show processing
        btn = document.getElementById("transpile-btn")
        original_text = btn.innerHTML
        btn.innerHTML = "Transpiling..."
        btn.disabled = True

        # Perform transpilation
        result = transpile_superlua(input_code)

        # Update output
        document.getElementById("output-code").value = result

        # Show success message
        show_status("Code transpiled successfully!")

        # Reset button
        btn.innerHTML = original_text
        btn.disabled = False

    except Exception as e:
        console.log(f"Error during transpilation: {str(e)}")
        # Show error message
        show_status(f"Error: {str(e)}", True)

        # Reset button
        btn = document.getElementById("transpile-btn")
        btn.innerHTML = "Transpile Code"
        btn.disabled = False

def load_vector_example(*args):
    example_code = """class Vector
    function new(self, x, y)
        self.x = x or 0
        self.y = y or 0
    end

    function add(self, other)
        return Vector:new(self.x + other.x, self.y + other.y)
    end

    function magnitude(self)
        return math.sqrt(self.x * self.x + self.y * self.y)
    end

    function toString(self)
        return "Vector(" .. self.x .. ", " .. self.y .. ")"
    end
end

-- Usage example (this will be preserved as-is)
local v1 = Vector:new(3, 4)
local v2 = Vector:new(1, 2)
local v3 = v1:add(v2)
print(v3:toString())"""
    document.getElementById("input-code").value = example_code

def load_person_example(*args):
    example_code = """class Person
    function new(self, name, age)
        self.name = name or "Unknown"
        self.age = age or 0
    end

    function greet(self)
        print("Hello, my name is " .. self.name)
    end

    function birthday(self)
        self.age = self.age + 1
        print(self.name .. " is now " .. self.age .. " years old!")
    end
end

-- Usage
local person = Person:new("Alice", 25)
person:greet()
person:birthday()"""
    document.getElementById("input-code").value = example_code

def load_calculator_example(*args):
    example_code = """class Calculator
    function new(self)
        self.result = 0
    end

    function add(self, value)
        self.result = self.result + value
        return self
    end

    function subtract(self, value)
        self.result = self.result - value
        return self
    end

    function multiply(self, value)
        self.result = self.result * value
        return self
    end

    function getResult(self)
        return self.result
    end

    function clear(self)
        self.result = 0
        return self
    end
end

-- Chainable calculator usage
local calc = Calculator:new()
local result = calc:add(10):multiply(2):subtract(5):getResult()
print("Result: " .. result)"""
    document.getElementById("input-code").value = example_code

# Add keyboard shortcut (Ctrl+Enter)
def handle_keydown(event):
    if event.ctrlKey and event.key == "Enter":
        transpile_code()

# Bind event handlers using JavaScript bridge
from pyodide.ffi import create_proxy

transpile_proxy = create_proxy(transpile_code)
vector_proxy = create_proxy(load_vector_example)
person_proxy = create_proxy(load_person_example)
calculator_proxy = create_proxy(load_calculator_example)
keydown_proxy = create_proxy(handle_keydown)

document.getElementById("transpile-btn").addEventListener("click", transpile_proxy)
document.getElementById("vector-example").addEventListener("click", vector_proxy)
document.getElementById("person-example").addEventListener("click", person_proxy)
document.getElementById("calculator-example").addEventListener("click", calculator_proxy)
document.getElementById("input-code").addEventListener("keydown", keydown_proxy)

# Initial status
hide_status()
console.log("SuperLua Transpiler loaded successfully!")
    </py-script>
</body>
</html>
